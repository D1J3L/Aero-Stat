{% extends 'base.html' %} {% block content %}
<div id="map" style="height: 100vh; width: 100vw"></div>

<script>
  // Shane's default bounds, need to find how to get self location + bounds
  let latMax = 44;
  let latMin = 43;
  let longMax = -73;
  let longMin = -74;
  // If scrolled previously, bounds would be saved in localStorage.bounds
  let newBounds;
  if (localStorage.aeroStatsBounds) {
    console.log(localStorage.aeroStatsBounds);
    newBounds = JSON.parse(localStorage.aeroStatsBounds);
    latMax = newBounds._northEast.lat;
    latMin = newBounds._southWest.lat;
    longMax = newBounds._northEast.lng;
    longMin = newBounds._southWest.lng;
  }
  // Plug in planes here using flight data
  //   const f = {{closest_flights}};
  //   console.log(f);

  // Plug in planes end
  var map = L.map('map').fitBounds([
    [latMin, longMax],
    [latMax, longMin],
  ]);
  L.tileLayer(
    'https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}',
    {
      attribution:
        'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
      maxZoom: 18,
      id: 'mapbox/streets-v11',
      tileSize: 512,
      zoomOffset: -1,
      accessToken:
        'pk.eyJ1Ijoic2R1cHJlZSIsImEiOiJja3hpNXoyNGw0dWUxMnBtdTQ5ZjI4MmZsIn0.19iQPPtrr4jFeqmOLEJ1BA',
    }
  ).addTo(map);
  {% for flight in flight_data_parsed%}
  // Add icon

  L.Icon.Default.imagePath = "https://www.clipartmax.com/png/full/333-3330249_113-origami-icons-plane-icon-outline-png.png"
  // L.Icon.Default.imagePath = "static/images/plane_icon.png"

  L.marker([
  {{flight.latitude}},{{flight.longitude}},
  ], {
  }).addTo(map);

  // Assign rotational attribute
  document.getElementsByClassName('leaflet-marker-icon')[document.getElementsByClassName('leaflet-marker-icon').length-1].setAttribute('true_track', {{flight.true_track}});

  // Rotate!
  document.getElementsByClassName('leaflet-marker-icon')[document.getElementsByClassName('leaflet-marker-icon').length-1].style.transform = `${document.getElementsByClassName('leaflet-marker-icon')[document.getElementsByClassName('leaflet-marker-icon').length-1].style.transform} rotate(${document.getElementsByClassName('leaflet-marker-icon')[document.getElementsByClassName('leaflet-marker-icon').length-1].getAttribute('true_track')}deg)`

  {% endfor %}
   // Remove leftover shadow
  document.getElementsByClassName('leaflet-shadow-pane')[0].remove()

  //Detects pan, provides new bounds, top right corner(north east) & bottom left corner(southWest)
  map.on('moveend', function () {
    // localStorage.aeroStatsBounds = JSON.stringify(map.getBounds());
    let gotBounds = fastGetBounds();
    // refresh right after scrolling, carrying bounds data

    // let latMinId, latMaxId, longMinId, longMaxId;
    let latMinId = gotBounds._northEast.lat
    latMinId = latLongSign(latMinId)
    let latMaxId = gotBounds._southWest.lat
    latMaxId = latLongSign(latMaxId)
    let longMinId = gotBounds._northEast.lng
    longMinId = latLongSign(longMinId)
    let longMaxId = gotBounds._southWest.lng
    longMaxId = latLongSign(longMaxId)
    window.location.href = `/update/${latMinId}/${latMaxId}/${longMinId}/${longMaxId}/`;
  });
  // Makes for smoother scroll right up till refresh
  function fastGetBounds() {
    localStorage.aeroStatsBounds = JSON.stringify(map.getBounds());
    return map.getBounds();
    setTimeout(function () {
      fastGetBounds();
    }, 10);
  }

  function latLongSign(coord){
    if (coord>0){
        return 'p'+coord*10000000000000000
    } else {
        return 'n'+coord*-10000000000000000
    }
  }
</script>
{% endblock %}
